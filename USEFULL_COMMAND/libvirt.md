# Среды виртуализации

* Libvirt и его компонентах.
* Гипервизорах KVM и XEN.
* Программном обеспечении Xen, Hyper-V, QEMU, VMware vSphere. 

## Libvirt
Libvirt — это open-source набор инструментов, который предоставляет унифицированный и абстрактный интерфейс для взаимодействия с гипервизорами и системами виртуализации, включая KVM, Xen, VMware и другие. Llibvirt позволяет управлять всеми аспектами вашей виртуализированной среды с помощью простого и мощного API. 

Объекты, которыми управляет libvirt
* Виртуальные машины (virtual machines) — с помощью libvirt можно создавать, запускать, останавливать, приостанавливать, удалять и мигрировать виртуальные машины.
* Хосты (hosts) — физические компьютеры, на которых установлены гипервизоры и которые управляют виртуальными машинами. Libvirt позволяет управлять хостами, включая добавление и удаление хостов, управление ресурсами, мониторинг состояния хостов и т. д.
* Хранилища данных (storage pools) — используются для хранения дисковых образов виртуальных машин. Это различные типы хранилищ: файловые системы, iSCSI, Fibre Channel, NFS и другие. Libvirt обеспечивает управление хранилищами данных, включая создание, удаление, подключение и отключение хранилищ.
* Сети (networks) — libvirt позволяет создавать сети и управлять ими, включая создание виртуальных сетевых интерфейсов, маршрутизацию, настройку NAT и прокси и другие сетевые функции.
* Снимки (snapshots) — сохраняют текущее состояние виртуальной машины и восстанавливают его при необходимости. Libvirt позволяет создавать снимки виртуальных машин, управлять ими и применять их.

[ПОМОЩЬ по libvirt](https://rabexc.org/posts/how-to-get-started-with-libvirt-on)

------------------
**Скрипт для создания виртуальной машины**
~/vm-install.sh
```bash
#!/bin/bash
virt-install \
--virt-name kvm \
--os-variant centos7 \
--memory 1024 \
--graphics none \
--extra-args='console=ttyS0' \
--location https://.....
--disk path=/disk/VMs/centos.qcow2,size=10,bus=virtio,io=threads,cache=none
 ```

### Компоненты libvirt
Libvirt состоит из нескольких компонентов, каждый из которых выполняет определённые функции в управлении виртуализированными средами.
* Библиотека **libvirt (libvirt)** — основной компонент, реализующий API и набор инструментов для взаимодействия с гипервизорами и виртуализационными платформами. Библиотека libvirt обеспечивает унифицированный интерфейс на различных уровнях абстракции, позволяя приложениям управлять виртуальными машинами, хостами, хранилищами данных, сетями и другими ресурсами.
Библиотека libvirt доступна на разных языках программирования, таких как C, Python, Java и других.
* Демон **libvirtd (libvirtd)** — служба, которая запускается на хост-машине и обеспечивает управление гипервизорами и виртуализированными средами. Демон libvirtd предоставляет удалённое управление, позволяя администраторам контролировать виртуализированные ресурсы и управлять ими.
* Утилиты командной строки — обеспечивают возможность исполнения команд для мониторинга виртуализированных сред и управления ими.

Некоторые из самых популярных утилит командной строки:
* **virsh** для интерактивного управления виртуализированными ресурсами,
* **virt-install** для установки виртуальных машин,
* **virt-manager** для графического управления виртуализированными ресурсами.
* **API** — библиотеки API на различных языках программирования — C, Python, Java и другие. Эти библиотеки позволяют разработчикам создавать собственные приложения, интегрированные с libvirt, для автоматизации управления виртуализированными ресурсами.

* Драйверы гипервизора — каждый гипервизор имеет свой собственный драйвер, который взаимодействует с соответствующей виртуализационной платформой. Драйверы гипервизора обеспечивают взаимодействие между libvirt и гипервизором, обрабатывая запросы API и управляя ресурсами гипервизора.

Компоненты libvirt работают совместно для управления виртуализированными средами. Библиотека libvirt предлагает единый и гибкий подход, который снижает сложность и повышает эффективность управления виртуализацией, независимо от используемых гипервизоров или виртуализационных платформ.

Посмотрим, как это работает на практике.\
Проверим, поддерживается ли аппаратная виртуализация. Работать будет и без её поддержки, только гораздо медленнее:\
`egrep --color=auto 'vmx|svm|0xc0f' /proc/cpuinfo`

#### KVM  — это модуль ядра Linux, поэтому нужно проверить, загружен ли он:\
`lsmod | grep kvm`

Если модуль не загружен:

`modprobe kvm`
`modprobe kvm_intel # или modprobe kvm_amd`

Возможна ситуация, когда аппаратная виртуализация выключена в BIOS. Поэтому, если модули kvm_intel/kvm_amd не подгружаются, нужно проверить настройки BIOS.

Теперь установим необходимые пакеты:

`yum install libvirt-client libvirt-daemon qemu qemu-kvm`

или

`apt install libvirt-client libvirt-daemon qemu qemu-kvm`
```
sudo apt install qemu qemu-kvm libvirt-clients libvirt-daemon-system virtinst bridge-utils
 sudo systemctl enable libvirtd
 sudo systemctl start libvirtd
```
 

### Утилита virsh
Virsh — это утилита командной строки в libvirt, которая предоставляет интерактивный интерфейс для управления виртуализированными средами. Она позволяет взаимодействовать с гипервизорами и виртуализированными машинами, выполнять операции и получать информацию о состоянии системы.

Некоторые примеры использования virsh.

Создание виртуальной машины:
`virsh create /path/to/vm.xml` Эта команда создаёт новую виртуальную машину из XML-файла конфигурации, который содержит параметры виртуализации.

`virt-xml-validate /path/to/XML/file`\
[https://libvirt.org/format.html](https://libvirt.org/format.html)

Запуск и остановка виртуальной машины:\
`virsh start <vm_name>`\
`virsh shutdown <vm_name>`\
`virsh destroy <vm_name>`

**CTRL+5** - выйти из коммандной строки гостевой ОС в хостовую. ВМ будет работать

Команда start запускает остановленную виртуальную машину, а команда shutdown отправляет сигнал остановки виртуальной машине, чтобы она корректно завершила работу.
3. Мониторинг состояния виртуальной машины:

`virsh list --all`\
`virsh dominfo <vm_name>`\
`virsh undefine <vm_name>` - удалить

Команда `list --all` отображает список всех виртуальных машин на хосте, включая остановленные и запущенные.
Команда `dominfo` выводит информацию о конкретной виртуальной машине: статус, количество процессоров, объём памяти и другие атрибуты.

Управление сетью:\
`virsh net-list --all`\
`virsh net-start <network_name>`

Команда `net-list --all` выводит список всех сетевых подключений, включая остановленные и запущенные. Команда net-start запускает остановленное сетевое подключение.

Получение информации о хосте:
`virsh nodeinfo`\
`virsh nodememstats`

Команда nodeinfo показывает информацию о хосте: модель процессора, количество ядер, общий объём памяти.\
Команда nodememstats отображает статистику использования памяти на хосте.

Создание снимков виртуальных машин и управление ими:\
`virsh snapshot-create <vm_name> --name <snapshot_name> --description <snapshot_description>`\
`virsh snapshot-list <vm_name>`\
`virsh snapshot-revert <vm_name> --snapshotname <snapshot_name>`

Команда snapshot-create создаёт снимок состояния виртуальной машины.\
Команда snapshot-list выводит список снимков для указанной виртуальной машины. Команда snapshot-revert восстанавливает виртуальную машину из определённого снимка.

Настройка автозапуска виртуальной машины при старте хоста:\
`virsh autostart <vm_name>`

Для отмены автозапуска:\
`virsh autostart –disable <vm_name>`

 

### Утилита virt-install
Чтобы начать работу с виртуальными машинами, следует использовать утилиту virt-install.

`Virt-install` — это утилита командной строки, которая предоставляется пакетом Virtual Machine Manager (VMM) для управления гостевыми виртуальными машинами на хост-сервере. Она позволяет автоматизировать процесс создания и установки виртуальных машин. С её помощью можно управлять множеством параметров: аппаратные ресурсы (процессоры, память, диск), сетевые настройки и другие параметры. Virt-install облегчает задачу администрирования виртуальных машин и упрощает внедрение и управление ими.

Рассмотрим пример, как установить виртуальную машину с именем mkdev-vm-0, используя установочный образ операционной системы CentOS:

```bash
virt-install --name mkdev-vm-0 \
--location ~/Downloads/CentOS-7-x86_64-Minima-2009l.iso \
--memory=1024 --vcpus=1 \
--disk size=8
```
где:
`--name mkdev-vm-0 устанавливает имя виртуальной машины на mkdev-vm-0.` Имя может быть выбрано по вашему усмотрению, и префикс «mkdev-» здесь просто служит идентификатором.

`--location ~/Downloads/CentOS-7-x86_64-Minima-2009l.iso` определяет местоположение установочного образа ОС CentOS.\
В этом случае образ находится по пути ~/Downloads/CentOS-7-x86_64-Minima-2009l.iso.\
Virt-install будет использовать этот образ для установки операционной системы на виртуальную машину.\
Можно в качестве местоположения установочного образа указывать URL:\
`–location https://mirror.linux-ia64.org/centos/7/os/x86_64/`

`--memory=1024` задаёт объём оперативной памяти для виртуальной машины. Здесь установлено значение в 1 024 МБ (1 ГБ).

`--vcpus=1` определяет количество виртуальных ЦП (ядер процессора), которые будут выделены виртуальной машине. В этом случае установлено значение 1, что означает, что будет предоставлено одно виртуальное ядро процессора.

`--disk size=8` задаёт размер дискового пространства для виртуальной машины. Здесь указано значение 8, что означает 8 ГБ. Virt-install выделит диск указанного размера для виртуальной машины.

 

### Утилита virt-manager
`Virt-manager (Virtual Machine Manager)` — это графический интерфейс для управления виртуализацией на хост-сервере. Virt-manager обеспечивает интуитивно понятную и простую в использовании среду для управления виртуальными машинами. Он предоставляет доступ ко всем основным функциям виртуализации: создание виртуальных машин, управление их ресурсами, установка операционных систем, настройка сети и многое другое.

Как использовать virt-manager

Создание новой виртуальной машины.
* открыть virt-manager и выбрать «Создать новую виртуальную машину»;
* выбрать источник установочного образа — ISO-образ, сетевую загрузку, предварительно созданный диск и т. д;
* указать размер оперативной памяти, количество виртуальных ЦП и другие параметры;
* настроить сеть, диск, графический вывод и другие параметры;
* установить операционную систему на виртуальную машину.
* Управление виртуальными машинами:
* запуск, приостановка, остановка и удаление виртуальных машин;
* редактирование аппаратных ресурсов и настроек виртуальных машин;
* мониторинг ресурсов и состояния виртуальных машин;
* копирование и клонирование виртуальных машин;
* управление сетевыми настройками, подключение виртуальных машин к сети.
* Подключение к удалённому хосту:
* virt-manager позволяет подключаться к удалённым хост-серверам через сеть;
* возможность управлять виртуальными машинами на удалённых системах. 

### KVM (Самый быстрый при наличии аппаратной виртуализации)
Red Hat создала ассоциацию Open Virtualization Alliance, чтобы решить проблему отсутствия базового гипервизора для ядра Linux. Так и был создан гипервизор KVM, или Kernel-based Virtual Machine.\
Гипервизор KVM — загружаемый модуль ядра Linux, который предназначен для виртуализации на платформе Linux x86.\
Сам модуль содержит:
* компонент собственной виртуализации (kvm.ko);
* процессорно-специфический загружаемый модуль kvm-amd.ko или kvm-intel.ko.
* Начиная с версии ядра 2.6.20, KVM является основной составляющей Linux. Если у вас стоит Linux, то у вас уже есть KVM. Необходимым условием для использования KVM является поддержка одной из инструкций виртуализации — Intel VT-x, AMD-V или ARM с поддержкой EL2.

Сам по себе KVM не выполняет эмуляции. Вместо этого программа, работающая в пространстве пользователя, использует интерфейс /dev/kvm для настройки адресного пространства гостя виртуальной машины, через него же эмулирует устройства ввода-вывода и видеоадаптер.

KVM позволяет виртуальным машинам использовать немодифицированные образы дисков QEMU, VMware и других, содержащие ОС.

Каждая виртуальная машина имеет своё собственное виртуальное аппаратное обеспечение:\
сетевые карты,
диск,
видеокарту,
другие устройства.

#### активация режима KVM для virtbox на винде

Чтобы включить вложенную виртуализацию Nested VT-x/AMD-v в VirtualBox в системах GNU/Linux, откройте cmd windows выполните команды:

`vboxmanage list vms`\
`VBoxManage modifyvm “название виртуальной системы” --nested-hw-virt on`

Так как KVM — это модуль ядра Linux, то нужно проверить,\
загружен ли он уже, и если нет, то загрузить:\
`lsmod | grep kvm`\
`modprobe kvm`\
`modprobe kvm_intel` - пример для intel

Проверьте наличие аппаратной виртуализации:\
`egrep -c ‘(vmx|svm)’ /proc/cpuinfo`

! Обратите внимание: Запуск виртуальных машин производится из-под пользователя НЕ **root** без ssh подключения , так как вам нужна GNU оболочка, иначе возникнет ошибка: Gtk-WARNING **: xx:xx:xx.xx: cannot open display:

Установите полный пакет виртуализации (qemu; Libvirt; virt-manager):\
`sudo apt install qemu-kvm libvirt-clients libvirt-daemon-system bridge-utils virtinst libvirt-daemon virt-manager`

Скачаем iso образ Alpinelinux и запомним, где он лежит, на пример :\
`wget `[dl-cdn.alpinelinux.org...86_64.iso](https://dl-cdn.alpinelinux.org/alpine/v3.12/releases/x86_64/alpine-standard-3.12.3-x86_64.iso%60)

Создайте жёсткий диск для последующей установки образа:\
`qemu-img create -f qcow2 Alpinelinux 4G`\
-qemu-img create - создать образ --f - файл

* qcow2 - формат QEMU
* Alpinelinux - название диска
* 4G- размер

Запустите виртуальную машину с гостевой ОС Alpinelinux:\
` qemu-system-x86_64 -hda Alpinelinux -boot d -cdrom ./alpine-standard-3.12.3-x86_64.iso -m 640 `

* qemu-system-x86_64 - требуемая архитектура
* hda Alpinelinux -boot d - носитель и загрузка с
* cdrom /root/alpine-standard-3.13.5-x86.iso - путь к файлу
* m 640- количество ОЗУ

### Xen
Xen — это гипервизор с открытым исходным кодом, который позволяет запускать несколько виртуальных машин на одном физическом хосте.

Управление XEN может осуществляться с помощью утилиты командной строки xl, которая является стандартным интерфейсом для управления виртуальными машинами XEN.

Примеры команд для управления XEN

Отобразить список запущенных виртуальных машин и их текущее состояние:
`xl list`

Создать новую виртуальную машину на основе конфигурационного файла:\
`xl create /путь/к/конфигурационному_файлу`

Выключить запущенную виртуальную машину с именем myvm:\
`xl shutdown myvm`

Принудительно выключить виртуальную машину:\
`xl destroy myvm`

Получить доступ к консоли виртуальной машины:\
`xl console myvm`

Удалить виртуальную машину:\
`xl delete myvm`

 

### Hyper-V
Hyper-V — система аппаратной виртуализации для x64-систем на основе гипервизора для систем Windows. Доступна в серверных версиях Windows, а также в части десктопных — Windows 10 Pro, Windows 11.

Вот некоторые примеры команд для управления Hyper-V.

Создать виртуальную машину:\
`New-VM -Name "Моя виртуальная машина" -MemoryStartupBytes 2GB -NewVHDPath "C:\Путь\к\файлу.vhdx" -NewVHDSizeBytes 60GB`

Запустить виртуальную машину:\
`Start-VM -Name "Моя виртуальная машина"`

Остановить виртуальную машину:\
`Stop-VM -Name "Моя виртуальная машина"`

Просмотреть список виртуальных машин:\
`Get-VM`

Удалить виртуальную машину:\
`Remove-VM -Name "Моя виртуальная машина"`

 

### QEMU (медленнее KVM в несколько раз)
QEMU (Quick Emulator) — это программное обеспечение, которое позволяет эмулировать аппаратные платформы и создавать виртуальные машины. Оно широко используется для разработки, тестирования и эмуляции операционных систем и устройств.

QEMU имеет множество возможностей, включая эмуляцию процессора, устройств ввода/вывода и сетевой аппаратуры. Он поддерживает различные архитектуры: x86, ARM, MIPS, PowerPC и другие. Управление QEMU происходит через командную строку путём указания необходимых параметров и опций.

QEMU может работать в двух режимах:
полная эмуляция системы — полностью эмулирует устройство, включая все его компоненты, процессор и различные периферийные устройства. Он может использоваться для запуска нескольких ОС без перезагрузки или отладки системного кода;

эмуляция пользовательского режима — работает только для Linux-хоста, позволяет запускать процессы Linux, скомпилированные для одной архитектуры, в другой, например ARM-программы в x86. Полезно для разработки, кросс-компиляции и отладки.

Для управления эмулятором существует множество команд, но их можно разделить на группы:
* qemu-архитектура — эмуляция окружения пользователя для указанной архитектуры;
* qemu-system-архитектура — эмуляция полной системы для архитектуры;
* qemu-img — утилита для работы с дисками;
* qemu-io — утилита для работы с вводом/выводом на диск;
* qemu-user — оболочка для qemu-архитектуры, позволяет запускать программы других архитектур в этой системе;
* qemu-system — оболочка для qemu-system-архитектуры, позволяет полностью эмулировать систему нужной архитектуры.

Вот некоторые основные команды управления QEMU.\
Запуск виртуальной машины с использованием диска myimage.img:\
`qemu-system-x86_64 -hda myimage.img`

Запуск виртуальной машины с сетевой картой:\
`qemu-system-x86_64 -hda myimage.img -net nic -net user`

Выбор стандартного VGA-адаптера:\
`qemu-system-x86_64 -hda myimage.img -vga std`

Открытие монитора QEMU:\
`qemu-system-x86_64 -hda myimage.img -monitor stdio`

Более сложный пример:\

`qemu-img create -f qcow2 test 1G`
`qemu-system-x86_64 -hda ubuntu.qcow -boot d -cdrom ~/downloads/name_iso.iso -m 640`

Здесь первая команда используется для создания виртуального жёсткого диска формата qcow2 с именем test и размером 1 гигабайт.\
Вторая выполняет запуск ВМ с использованием виртуального жёсткого диска ubuntu.qcow в качестве главного диска. Виртуальная машина будет загружаться с указанного образа диска ~/downloads/name_iso.iso. Ключ -boot d указывает на то, что загрузка будет производиться с CD/DVD диска. Также устанавливается ограничение на использование оперативной памяти в размере 640 мегабайт с помощью ключа m 640. 

### VMware vSphere
VMware vSphere — это виртуализационная платформа, разработанная компанией VMware. VMware vSphere используется в корпоративной среде для создания виртуальной инфраструктуры и управления ей. Она позволяет объединить физические серверы в единую платформу, чтобы улучшить эффективность использования ресурсов и упростить управление ими.

В состав VMware vSphere входят следующие компоненты:
* Гипервизор VMware ESXi.
* VMware vCenter Server — сервер управления, позволяющий администраторам управлять всей виртуальной инфраструктурой из одного места. Он предоставляет функции мониторинга, управления, масштабирования и резервного копирования виртуальных машин.
* VMware vSphere Client — графический интерфейс, который позволяет администраторам удобно управлять виртуальными машинами, хранилищем данных и сетями.
* VMware vSphere Web Client — веб-интерфейс для управления виртуальной инфраструктурой VMware vSphere. Он предоставляет широкие возможности управления и конфигурирования, доступные через веб-браузер.
* VMware vSphere Update Manager — инструмент, который обеспечивает автоматическое обновление и управление патчами для хост-серверов, виртуальных машин и гостевых операционных систем.

Перечисленные компоненты совместно образуют интегрированную платформу виртуализации, которая облегчает развёртывание, масштабирование виртуальных инфраструктур в предприятии и управление ими.\
Центральным компонентом платформы виртуализации VMware vSphere является ESXi. 

#### VMware ESXi
VMware ESXi — это гипервизор, разработанный компанией VMware. ESXi — это гипервизор первого типа, что означает, что он работает на аппаратных ресурсах компьютера, без операционной системы-хоста.\
ESXi применяется для:
* виртуализации серверов,
* создания виртуальных центров обработки данных,
* облачной виртуализации.

Основные возможности ESXi:
* запуск операционных систем (Windows, Linux, Unix и другие) в качестве гостевых ОС на виртуальных машинах;
* динамическое выделение ресурсов для виртуальных машин — процессорное время, память, хранилище и сетевые ресурсы;
* механизмы защиты, включая изоляцию виртуальных машин друг от друга и защиту от угроз — вредоносное ПО или несанкционированный доступ;
* инструменты для централизованного управления, мониторинга и автоматизации виртуальных сред.
